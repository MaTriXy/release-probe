version: 2.0

defaults: &defaults
  working_directory: ~/release-probe
  docker:
      - image: ychescale9/android-sdk:1.0
  environment:
    JAVA_TOOL_OPTIONS: "-Xmx2g"
    GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false -Dkotlin.incremental=false"
    TERM: dumb

save_gradle_cache: &save_gradle_cache
  save_cache:
    key: jars-{{ checksum "build.gradle" }}-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
    paths:
      - ~/.gradle

restore_gradle_cache: &restore_gradle_cache
  restore_cache:
    key: jars-{{ checksum "build.gradle" }}-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}

jobs:
  build:
    <<: *defaults

    steps:
      - run:
          name: Setup Environment Variables
          command: |
            echo 'export BUILD_NUMBER="$CIRCLE_BUILD_NUM"' >> $BASH_ENV

      - checkout

      - *restore_gradle_cache

      - run:
          name: Download Dependencies
          command: ./gradlew androidDependencies

      - *save_gradle_cache

      - run:
          name: Decrypt Secrets
          command: |
            openssl aes-256-cbc -md sha256 -d -in secrets/release-probe.aes -out secrets/release-probe.keystore -k $ENCRYPT_KEY

      - run:
          name: Assemble
          command: ./gradlew assemble bundleProdRelease
      - store_artifacts:
          path: app/build/outputs/

      - run:
          name: Cleanup Secrets
          command: rm -f secrets/release-probe.keystore

      - run:
          name: Test
          command: |
            ./gradlew test
            mkdir -p ~/junit/
            find . -type f -regex ".*/build/test-results/.*xml" -exec cp --parents {} ~/junit/ \;
      - store_test_results:
          path: ~/junit
      - store_artifacts:
          path: ~/junit

      - run:
          name: Android Lint
          command: ./gradlew :app:lint
      - store_artifacts:
          path: app/build/reports/lint-results.html

workflows:
  version: 2
  build_and_test:
    jobs:
      - build:
          filters:
            branches:
              only:
                # TODO - master
